<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">
<head th:replace="fragments/admin-header :: admin-header-css"></head>
<body>
	<div class="skin-blu skin-admin">
		<header th:replace="fragments/admin-header :: admin-header"></header>
		<aside th:replace="fragments/admin-nav-bar :: admin-nav-bar"></aside>
		<div class="content-wrapper" style="padding-top: 5%">
			<div class="menu-content"
				style="overflow-y: auto; max-width: 860px; margin: 0 auto;">
				<div class="box box-primary p-3" style="min-height: 300px;">
					<div class="all-case-info-detail">
						<div class="small-wrap">
							<h5 class="text-center">详细信息</h5>
							<form id="questionForm">
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">问题编号</label>
									<div class="col-sm-9">
										<input type="text" class="form-control" disabled="disabled" th:value="${question.id}" id="currentQuestion" />
									</div>
								</div>
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">问题描述</label>
									<div class="col-sm-9">
										<input type="text" class="form-control" disabled="disabled" th:value="${question.description}" id="currentQuestionDesc" />
									</div>
								</div>
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">是否是根问题</label>
									<div class="col-sm-9 pt-1">
										<label class="radio-inline">
											<input type="radio" disabled="disabled" name="isRootQuestionRadios" value="Y" th:checked="${question.isRootQuestion == 'Y'}" th:text="是" />
										</label> 
										<label class="radio-inline">
											<input type="radio" disabled="disabled" name="isRootQuestionRadios" value="N" th:checked="${question.isRootQuestion == 'N'}" th:text="否" />
										</label>
									</div>
								</div>
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">问题类型</label>
									<div class="col-sm-9 pt-1">
										<label class="radio-inline">
											<input disabled="disabled" type="radio" name="questionTypeRadios" value="0" th:checked="${question.questionType == '0'}" th:text="单选" />
										</label>
										<label class="radio-inline">
											<input disabled="disabled" type="radio" name="questionTypeRadios" value="1" th:checked="${question.questionType == '1'}" th:text="多选" />
										</label>
										<label class="radio-inline">
											<input disabled="disabled" type="radio" name="questionTypeRadios" value="2" th:checked="${question.questionType == '2'}" th:text="文本输入" />
										</label>
									</div>
								</div>
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">所属案件类型</label>
									<div class="col-sm-9">
										<select class="form-control" th:id="selectFalltypus" th:attr="disabled=${question.belongsToFalltypus ne null} ? 'disabled' : 'false'">
											<option value="-1">选择从属案件类型</option>
											<option th:each="belongsToFalltypus : ${availableFalltypus}"
												th:id="${belongsToFalltypus.id}"
												th:value="${belongsToFalltypus.id}"
												th:text="${belongsToFalltypus.name}"
												th:selected="(${question.belongsToFalltypus} == ${belongsToFalltypus.id})">
											</option>
										</select>
									</div>
								</div>
								<div class="form-group row">
									<label for="" class="col-sm-3 col-form-label">操作</label>
									<div class="col-sm-9">
										<button type="button"
												th:if="${question.belongsToFalltypus eq null}"
												th:id="${question.id}+_currentBind"
												th:attr="disabled=${question.belongsToFalltypus ne null} ? 'disabled' : 'false'"
												class="addQFMapping btn btn-law btn-sm">绑定</button>
										<button class="btn btn-law btn-sm" 
												type="button" id="unbindQFMapping" 
												th:if="${question.belongsToFalltypus ne null}">解绑</button>
										<button class="btn btn-law btn-sm" 
												type="button" 
												id="editQuestionInfo">编辑</button>
										<button type="button" 
												class="btn btn-law btn-sm" 
												style="display: none" 
												id="saveEditQuestionInfo">保存</button>
										<button type="button"
												class="btn btn-sm btn-outline-dark" 
												style="display: none" 
												id="cancelEditQuestionInfo">取消</button>

									</div>
								</div>
							</form>
						</div>
						<div class="mt-5 table-wrap w-100 scroll-y scroll-y-400">
							<table class="table table-sm table-bordered">
								<thead class="thead-light">
									<tr>
										<th scope="col">问题编号</th>
										<th scope="col">问题描述</th>
										<th scope="col">匹配下级问题</th>
										<th scope="col" style="min-width: 200px">操作</th>
									</tr>
								</thead>
								<tbody>
									<tr th:if="${mappedQuestionAnswers eq null}">
										<td width="150" th:text="没有数据"></td>
									</tr>
									<tr th:if="${mappedQuestionAnswers ne null}" th:each="answer : ${mappedQuestionAnswers}">
										<td>
											<input class="form-control" disabled="disabled" type="text" th:id="${answer.id}+_currentAnswer" th:value="${answer.id}" />
										</td>
										<td>
											<input class="form-control" disabled="disabled" type="text" th:id="${answer.id}+_currentAnswerDesc" th:value="${answer.description}" />
										</td>
										<td>
											<select class="form-control" 
													th:attr="disabled=${#strings.isEmpty(answer.description) or answer.nextQuestionId ne null} ? 'disabled' : 'false'"
													th:id="${answer.id}+_selectParent">
												<option value="-1">选择下级问题</option>
												<option th:each="nextQuestion : ${availableQuestions}"
														th:id="${nextQuestion.id}" 
														th:value="${nextQuestion.id}"
														th:text="${nextQuestion.description}"
														th:selected="(${answer.nextQuestionId} == ${nextQuestion.id})">
												</option>
											</select>
										</td>
										<td>
											<button type="button"
													th:if="${answer.nextQuestionId eq null}"
													th:id="${answer.id}+_currentBind"
													th:attr="disabled=${#strings.isEmpty(answer.description) or (answer.nextQuestionId ne null)} ? 'disabled' : 'false'"
													class="addQAMapping btn btn-law btn-sm btn-sm">绑定</button>
											<button type="button"
													class="unbindQAMapping btn btn-law btn-sm btn-sm"
													th:id="${answer.id}+_currentUnbind"
													th:if="${answer.nextQuestionId ne null}">解绑</button>
											<button type="button"
													class="editAnswerInfo btn btn-law btn-sm"
													th:id="${answer.id}+_editAnswerInfoBtn">编辑</button>
											<button type="button"
													class="deleteAnswerInfo btn btn btn-outline-dark btn-sm"
													th:id="${answer.id}+_deleteAnswerInfoBtn">删除</button>
											<button type="button"
													class="saveEditAnswerInfoBtn btn btn-law btn-sm"
													style="display: none"
													th:id="${answer.id}+_saveEditAnswerInfoBtn">保存</button>
											<button type="button"
													class="cancelEditAnswerInfo btn btn-law btn-sm"
													style="display: none"
													th:id="${answer.id}+_cancelEditAnswerInfoBtn">取消</button>
										</td>
									</tr>
								</tbody>
							</table>
							<p class="text-center mb-0">
								<button type="button" class="btn btn-law"
									onclick="history.go(-1)">返回</button>
							</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="modal fade" id="notificationModal" tabindex="-1" role="dialog" aria-labelledby="notificationModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title">提示信息</h4>
					</div>
					<div class="modal-body" id="modalContent"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					</div>
				</div>
			</div>
		</div>


	</div>
	<div th:replace="fragments/footer :: footer"></div>

	<script type="text/javascript">
		$(document).ready(function() {
			var questionId = $("#currentQuestion").val()
			var bindQFMappingBtnId = questionId + "_currentBind"

			$("#editQuestionInfo").on("click", function() {
				$(":input", "#questionForm").not(":button", ":submit", ":reset",":hidden").removeAttr("disabled")
				$(this).css("display", "none")
				$("#currentQuestion").attr("disabled", "disabled")
				$("#" + bindQFMappingBtnId).css("display", "none")
				$("#unbindQFMapping").css("display", "none")
				$("#saveEditQuestionInfo").css("display", "inline-block")
				$("#cancelEditQuestionInfo").css("display", "inline-block")
			})

			$("#cancelEditQuestionInfo").on("click", function() {
				$(":input", "#questionForm").not(":button", ":submit", ":reset", ":hidden").attr("disabled", "disabled");
				$(this).css("display", "none")
				$("#unbindQFMapping").css("display","inline-block")
				$("#saveEditQuestionInfo").css("display", "none")
				$("#editQuestionInfo").css("display", "inline-block")
				$("#" + bindQFMappingBtnId).css("display", "inline-block")
			})

			$("#unbindQFMapping").on("click", function() {
				$.ajax({
					type : 'PUT',
					url : '/disputeInfo/update/question/qfMapping',
					data : JSON.stringify({
						"id" : $("#currentQuestion").val(),
						"belongsToFalltypus" : null
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						location.reload()
					},
					error : function(error) {
						$("#modalContent").empty().append("解绑失败")
						$("#notificationModal").modal("show")
					}
				});
			})

			$("#saveEditQuestionInfo").on("click",function() {
				$.ajax({
					type : 'PUT',
					url : '/disputeInfo/update/question/basic',
					data : JSON.stringify({
						"id" : $("#currentQuestion").val(),
						"description" : $("#currentQuestionDesc").val(),
						"isRootQuestion" : $("input:radio[name='isRootQuestionRadios']:checked").val(),
						"questionType" : $("input:radio[name='questionTypeRadios']:checked").val(),
						"belongsToFalltypus" : $("#selectFalltypus").find("option:selected").attr("id")
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						if (data.code == "-1") {
							$("#modalContent").empty().append("修改失败:" + data.message)
							$("#notificationModal").modal("show")
						} else {
							location.reload()
						}
					},
					error : function(error) {
						$("#modalContent").empty().append("修改失败")
						$("#notificationModal").modal("show")
					}
				});
			})
			
			$(".addQFMapping").on("click",function() {
				$.ajax({
					type : 'PUT',
					url : '/public/question/updateQFMapping',
					data : JSON.stringify({
						"id" : $("#currentQuestion").val(),
						"belongsToFalltypus" : $("#selectFalltypus").find("option:selected").attr("id")
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						location.reload()
					},
					error : function(error) {
						$("#modalContent").empty().append("绑定失败")
						$("#notificationModal").modal("show")
					}
				});
			})

			$(".addQAMapping").on("click",function() {
				var index = $(this).attr("id").split("_")[0];
				var currentAnswerId = index;
				var questionContainerId = index + "_selectParent";
				//var buttonId = index + "_currentBind"
				var selectedQuestionId = $("#" + questionContainerId + "").find("option:selected").attr("id")

				$.ajax({
					type : 'PUT',
					url : '/admin/answer',
					data : JSON.stringify({
						"id" : currentAnswerId,
						"nextQuestionId" : selectedQuestionId
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						//$("#"+questionContainerId+" option[value='"+selectedQuestionId+"']").remove()
						/* $("#"+buttonId+"").attr("disabled", "disabled")
						$("#"+questionContainerId+"").attr("disabled", "disabled")
						$("#modalContent").empty().append("绑定成功")
						$("#notificationModal").modal("show") */
						location.reload()
					},
					error : function(error) {
						$("#modalContent").empty().append("绑定失败")
						$("#notificationModal").modal("show")
					}
				});
			})

			$(".editAnswerInfo").on("click",function() {
				var answerId = $(this).attr("id").split("_")[0]

				$("#" + answerId + "_currentAnswerDesc").removeAttr("disabled")
				$("#"+ answerId+ "_selectParent").removeAttr("disabled")

				$(this).css("display", "none")
				$("#"+ answerId+ "_currentBind").css("display", "none")
				$("#"+ answerId+ "_currentUnbind").css("display", "none")
				$("#"+ answerId+ "_saveEditAnswerInfoBtn").css("display","inline-block")
				$("#"+ answerId+ "_cancelEditAnswerInfoBtn").css("display","inline-block")
			})

			$(".cancelEditAnswerInfo").on("click", function() {
				location.reload()
			})

			$(".saveEditAnswerInfoBtn").on("click",function() {
				var index = $(this).attr("id").split("_")[0]

				$.ajax({
					type : 'PUT',
					url : '/disputeInfo/update/answer/basic',
					data : JSON.stringify({
						"id" : index,
						"description" : $("#"+ index+ "_currentAnswerDesc").val(),
						"nextQuestionId" : $("#"+ index+ "_selectParent").find("option:selected").attr("id")
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						location.reload()
					},
					error : function(error) {
						$("#modalContent").empty().append("修改失败")
						$("#notificationModal").modal("show")
					}
				});
			})

			$(".deleteAnswerInfo").on("click",function() {
				var answerId = $(this).attr("id").split("_")[0]

				$.ajax({
					type : 'DELETE',
					url : '/disputeInfo/answer/delete/'+ answerId,
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						location.reload();
					},
					error : function(error) {
						$("#modalContent").empty().append("修改失败")
						$("#notificationModal").modal("show")
					}
				});
			})

			$(".unbindQAMapping").on("click",function() {
				var _this = this

				$.ajax({
					type : 'PUT',
					url : '/disputeInfo/update/answer/qaMapping',
					data : JSON.stringify({
						"id" : $(_this).attr("id").split("_")[0],
						"nextQuestionId" : null
					}),
					contentType : "application/json; charset=utf-8",
					success : function(data) {
						location.reload()
					},
					error : function(error) {
						$("#modalContent").empty().append("解绑失败")
						$("#notificationModal").modal("show")
					}
				});
			})
		});
	</script>
</body>
</html>

